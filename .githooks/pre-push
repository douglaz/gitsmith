#!/usr/bin/env bash
set -euo pipefail

echo "üî® gitsmith pre-push checks..."
echo ""

# Check if we're in a nix environment
if command -v nix >/dev/null 2>&1 && [ -f "flake.nix" ]; then
    # Check formatting
    echo "üìù Checking code formatting..."
    if ! nix develop -c cargo fmt --check 2>/dev/null; then
        echo ""
        echo "‚ùå Code is not formatted. Please run 'nix develop -c cargo fmt' before pushing."
        echo ""
        echo "To see what needs formatting:"
        echo "  nix develop -c cargo fmt --check --verbose"
        exit 1
    fi
    echo "‚úÖ Formatting check passed"
    echo ""
    
    # Run clippy
    echo "üîé Running clippy linting..."
    if ! nix develop -c cargo clippy --all-targets -- -D warnings 2>&1; then
        echo ""
        echo "‚ùå Clippy found issues. Please fix them before pushing."
        echo ""
        echo "To see all issues:"
        echo "  nix develop -c cargo clippy --all-targets"
        echo ""
        echo "To attempt automatic fixes:"
        echo "  nix develop -c cargo clippy --all-targets --fix --allow-dirty"
        exit 1
    fi
    echo "‚úÖ Clippy check passed"
    echo ""
    
    # Run tests
    echo "üß™ Running tests..."
    if ! nix develop -c cargo test 2>&1; then
        echo ""
        echo "‚ùå Tests failed. Please fix them before pushing."
        echo ""
        echo "To see test output:"
        echo "  nix develop -c cargo test"
        exit 1
    fi
    echo "‚úÖ Tests passed"
    echo ""
else
    # Fallback to regular cargo
    echo "üìù Checking code formatting..."
    if ! cargo fmt --check 2>/dev/null; then
        echo ""
        echo "‚ùå Code is not formatted. Please run 'cargo fmt' before pushing."
        echo ""
        echo "To see what needs formatting:"
        echo "  cargo fmt --check --verbose"
        exit 1
    fi
    echo "‚úÖ Formatting check passed"
    echo ""
    
    # Run clippy
    echo "üîé Running clippy linting..."
    if ! cargo clippy --all-targets -- -D warnings 2>&1; then
        echo ""
        echo "‚ùå Clippy found issues. Please fix them before pushing."
        echo ""
        echo "To see all issues:"
        echo "  cargo clippy --all-targets"
        echo ""
        echo "To attempt automatic fixes:"
        echo "  cargo clippy --all-targets --fix --allow-dirty"
        exit 1
    fi
    echo "‚úÖ Clippy check passed"
    echo ""
    
    # Run tests
    echo "üß™ Running tests..."
    if ! cargo test 2>&1; then
        echo ""
        echo "‚ùå Tests failed. Please fix them before pushing."
        echo ""
        echo "To see test output:"
        echo "  cargo test"
        exit 1
    fi
    echo "‚úÖ Tests passed"
    echo ""
fi

echo ""
echo "‚úÖ All pre-push checks passed! Proceeding with push..."
echo ""